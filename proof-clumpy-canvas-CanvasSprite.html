<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TITLE</title>
<!--[if IE]><script type="text/javascript" src="js/excanvas.js"></script><![endif]-->
<script src="js/jquery-1.8.3.min.js"></script>
<script src="js/json2.js"></script>
<script src="js/clumpy/core/Clumpy.js"></script>
<script src="js/clumpy/timers/Scheduler.js"></script>
<script src="js/clumpy/eventing/Callbacks.js"></script>
<script src="js/clumpy/ui/listeners/Keyboard.js"></script>
<script src="js/clumpy/math/Byte.js"></script>
<script src="js/clumpy/math/Trig.js"></script>
<script src="js/clumpy/d3/D3.js"></script>
<script src="js/clumpy/grid/Grid.js"></script>
<script src="js/clumpy/geom/AxialVelocity.js"></script>
<script src="js/clumpy/canvas/CanvasLayer.js"></script>
<script src="js/clumpy/canvas/CanvasAnimation.js"></script>
<script src="js/clumpy/canvas/CanvasSprite.js"></script>

<script>
    window.onload = onWindowLoaded;
    var d3 = new clumpy_d3_D3(1, 500, 500, -30);
    var ticker = new clumpy_timers_Scheduler(50, false).addCall(render, this);
    var keys = new clumpy_ui_listeners_Keyboard(true, 50, 50);
    var dragon;
    var plane = {nCols:20, nRows:10, cellSize:100};
    var byte = new clumpy_math_Byte();
    function render() {
        if(byte.test(3)){
            // left and up
            dragon.state = 6;
        }else if(byte.test(6)){
            // right and up
            dragon.state = 8;
        }else if(byte.test(12)){
            // right and down
            dragon.state = 2;
        }else if(byte.test(9)){
            // left and down
            dragon.state = 4;
        }else if(byte.test(2)){
            // up
            dragon.state = 7;
        }else if(byte.test(4)){
            // right
            dragon.state = 1;
        }else if(byte.test(8)){
            // down
            dragon.state = 3;
        }else if(byte.test(1)){
            // left
            dragon.state = 5;
        }
        dragon.moveD3();
        dragon.velocity.resist();
        d3.flatten(dragon.d3, dragon);
        dragon.nextFrame(true);
    } 
    function onWindowLoaded(){
        dragon = new clumpy_canvas_CanvasSprite('dragon', 
                document.getElementById('canvas2'), 
                10,
                75,
                70).set({offsetX:37, offsetY:35});
        dragon.d3.y = -25;
        keys.addDown(37, onKeyDown, true).addDown(38, onKeyDown, true).addDown(39, onKeyDown, true).addDown(40, onKeyDown, true);
        keys.addUp(37, onKeyUp).addUp(38, onKeyUp).addUp(39, onKeyUp).addUp(40, onKeyUp);
        drawPlane();
        dragon.setSpriteUrl('images/dragon.gif');
        render();
        ticker.start();
    }
    
    function onKeyUp(keyCode){
        switch(keyCode){
            // arrow left - 37
            case 37:
                byte.remove(1);
                break;
            // arrow up - 38
            case 38:
                byte.remove(2);
                break;
            // arrow right - 39
            case 39:
                byte.remove(4);
                break;
            // arrow down - 40
            case 40:
                byte.remove(8);
                break;
        }
    }
    function onKeyDown(keyCode){
        switch(keyCode){
            // arrow left - 37
            case 37:
                dragon.velocity.decelerate(clumpy_geom_AxialVelocity.X);
                byte.add(1);
                break;
            // arrow up - 38
            case 38:
                dragon.velocity.accelerate(clumpy_geom_AxialVelocity.Z);
                byte.add(2);
                break;
            // arrow right - 39
            case 39:
                dragon.velocity.accelerate(clumpy_geom_AxialVelocity.X);
                byte.add(4);
                break;
            // arrow down - 40
            case 40:
                dragon.velocity.decelerate(clumpy_geom_AxialVelocity.Z);
                byte.add(8);
                break;
        }
    }
    
    function drawPlane() {
        var xz = {x:0, y:0, z:0};
        var flat = {x:0, y:0, scale:1};
        var normalSize = 10;
        var context = document.getElementById('canvas1').getContext('2d');
        context.fillStyle = "#000000";
        context.globalAlpha = 0.5;
        // var plane = {nCols:10, nRows:10, cellSize:100};
        for(var x=(-plane.nCols*plane.cellSize/2);x<=(plane.nCols*plane.cellSize/2);x+=plane.cellSize){
            for(var z=(-plane.nCols*plane.cellSize/2);z<=(plane.nCols*plane.cellSize/2);z+=plane.cellSize){
                xz.x = x;
                xz.z = z;
                if(xz.z <= -d3.middleZ) {
                    continue;
                }
                d3.flatten(xz, flat);
                context.beginPath();
                context.arc(flat.x + 250, flat.y + 250, normalSize * flat.scale, 0, Math.PI*2, true); 
                context.closePath();
                context.fill();
            }
        }
    }
</script>

<style>
    html, body {margin:0; padding:0; width:100%; height:100%;}
    #world {position:absolute; z-index:1; top:250px; left:250px; overflow:visible;}
    #canvas1 {position:absolute; z-index:1; top:-250px; left:-250px;}
    #canvas2 {position:absolute; z-index:2; top:-250px; left:-250px;} 
</style>
</head>
<body>
    <div id="world">
        <canvas id="canvas1" width="500" height="500"></canvas>
        <canvas id="canvas2"></canvas>
    </div>
</body>
</html>